<script>
import Wizard from '@shell/components/Wizard.vue';
import { SETTING } from '@shell/config/settings';
import { MANAGEMENT } from '@shell/config/types';
import { REPO_TYPE, REPO, CHART } from '@shell/config/query-params';
import { BLANK_CLUSTER } from '@shell/store/store-types.js';

import LabeledInput from '@components/Form/LabeledInput/LabeledInput.vue';
import { Banner } from '@components/Banner';
import { stringify } from '@shell/utils/error';

const URL_DOMAIN_REG = /[a-zA-Z0-9][-a-zA-Z0-9]{0,62}(\.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+\.?/;
const URL_REG = /(http|ftp|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&:/~\+#]*[\w\-\@?^=%&/~\+#])?/;

export default {
  props: {
    k8sAuditLog: {
      type:     Boolean,
      required: false,
      default:  false,
    },
    auditLogCollector: {
      type:     Object,
      default:  null,
      required: false
    },
    clusterId: {
      type:    String,
      default: BLANK_CLUSTER
    },
    auditLogSetting: {
      type:     Object,
      required: true
    },
    skipAppInstallSetting: {
      type:     Object,
      default:  null,
      required: false
    }
  },
  data() {
    const steps = [];
    const url = this.auditLogSetting?.value ?? '';

    if (!url) {
      steps.push(
        {
          name:    'deploymentComponents',
          label:   this.t('auditLog.installView.steps.deploymentCompoents.stepLabel'),
          subtext: this.t('auditLog.installView.steps.deploymentCompoents.stepLabel'),
          ready:   false,
        }
      );
    }

    if (this.k8sAuditLog && !this.auditLogCollector) {
      steps.push({
        name:    'installAuditLogCollector',
        label:   this.t('auditLog.installView.steps.installAuditLogCollector.stepLabel'),
        subtext: this.t('auditLog.installView.steps.installAuditLogCollector.label'),
        ready:   false,
      });
    }

    return {
      steps,
      errors:  [],
      url,
      loading: false,
    };
  },
  computed: {
    needInstallCollector() {
      return this.k8sAuditLog && !this.auditLogCollector;
    },
    urlValid() {
      return URL_REG.test(this.url?.trim());
    }
  },
  methods: {
    async handleSkipAppInstall() {
      this.loading = true;
      try {
        if (this.steps.find((s) => s.name === 'deploymentComponents')) {
          await this.saveAuditLogSetting();
        }
        const skipAppInstallSetting = await this.$store.dispatch(`management/clone`, { resource: this.skipAppInstallSetting });
        const v = JSON.parse(skipAppInstallSetting.value || '{}');

        v[this.clusterId] = true;
        skipAppInstallSetting.value = JSON.stringify(v);
        await skipAppInstallSetting.save();
      } catch (err) {
        this.errors = [stringify(err)];
      }
      this.loading = false;
    },
    async saveAuditLogSetting() {
      const url = this.url.trim();
      const [whitelistSetting, auditLogSetting] = await Promise.all([
        this.$store.getters['management/byId'](MANAGEMENT.SETTING, SETTING.WHITELIST_DOMAIN),
        this.$store.dispatch(`management/clone`, { resource: this.auditLogSetting })
      ]);
      const values = whitelistSetting?.value?.split(',') ?? [];
      const domain = URL_DOMAIN_REG.exec(url)?.[0] ?? url;

      values.push(domain);
      whitelistSetting.value = [...new Set(values)].filter((v) => v).join(',');

      auditLogSetting.value = url;

      await Promise.all([whitelistSetting.save(), auditLogSetting.save()]);
    },
    async finish(btnCb) {
      try {
        await this.saveAuditLogSetting();
        btnCb(true);
        // this.reload();
        // this.$store.dispatch('management/find', { type: MANAGEMENT.SETTING, id: SETTING.AUDIT_LOG_SERVER_URL }, { force: true })
      } catch (err) {
        this.errors = [err];
        btnCb(false);
      }
    },
    async chartRoute() {
      if (this.steps.find((s) => s.name === 'deploymentComponents')) {
        this.loading = true;
        try {
          await this.saveAuditLogSetting();
          this.loading = false;
        } catch (err) {
          this.errors = [err];
          this.loading = false;

          return;
        }
      }
      this.$router.push({
        name:   'c-cluster-apps-charts-install',
        params: { cluster: this.clusterId === BLANK_CLUSTER ? 'local' : this.clusterId },
        query:  {
          [REPO_TYPE]: 'cluster',
          [REPO]:      'pandaria-catalog',
          [CHART]:     'rancher-k8s-auditlog-collector',
        },
      });
    },

    reload() {
      this.$router.go();
    }
  },
  watch: {
    urlValid: {
      immediate: true,
      handler(v) {
        if (!v) {
          if (this.url?.trim() !== '') {
            this.errors = [this.t('validation.invalid', { key: SETTING.AUDIT_LOG_SERVER_URL }, true)];
          }

          return;
        }
        this.errors = [];
        const step = this.steps.find((s) => s.name === 'deploymentComponents');

        if (step) {
          step.ready = true;
        }
      }
    },
    auditLogSetting: {
      immediate: true,
      handler(v) {
        if (v) {
          this.url = v.value;
        }
      }
    },
    url(v) {
      if (v?.trim() === '') {
        this.errors = [this.t('auditLog.errors.required', { key: 'auditlog-server-url' })];
      }
    },
  },
  components: {
    Wizard, LabeledInput, Banner
  }
};
</script>
<template>
  <div class="install-view">
    <Wizard
      :steps="steps"
      :banner-title="t('auditLog.title')"
      :banner-title-subtext="t('auditLog.installView.steps.deploymentCompoents.label')"
      :edit-first-step="true"
      :errors="errors"
      banner-image="/_nuxt/shell/assets/images/generic-catalog.svg"
      header-mode=""
      :finish-mode="needInstallCollector ? 'install' : 'done'"
      @finish="finish"
    >
      <template
        v-if="needInstallCollector"
        #finish
      >
        <div />
      </template>
      <template #cancel>
        <div />
      </template>
      <template #deploymentComponents>
        <div class="mb-20">
          <Banner
            color="info"
          >
            <div v-clean-html="t('auditLog.installView.steps.deploymentCompoents.tips', {}, true)" />
          </Banner>
          <Banner
            color="info"
          >
            <div v-clean-html="t('auditLog.installView.steps.deploymentCompoents.address.tips')" />
          </Banner>
          <LabeledInput
            v-model:value="url"
            :localized-label="true"
            :required="true"
            :label="t('auditLog.installView.steps.deploymentCompoents.address.label')"
          />
        </div>
      </template>
      <template #installAuditLogCollector>
        <div class="mb-20">
          <Banner
            color="info"
          >
            <div v-clean-html="t('auditLog.installView.steps.installAuditLogCollector.endpointTips')" />
          </Banner>
          <Banner
            color="info"
          >
            <div v-clean-html="t('auditLog.installView.steps.installAuditLogCollector.deploymentTips')" />
          </Banner>
          <div class="flex justify-center gap-20 mt-20">
            <button
              class="btn role-primary"
              :disabled="loading"
              @click.prevent="chartRoute"
            >
              {{ t("auditLog.installView.steps.installAuditLogCollector.label") }}
            </button>
            <template v-if="k8sAuditLog">
              <button
                class="btn role-secondary"
                :disabled="loading"
                @click.prevent="handleSkipAppInstall"
              >
                {{ t("auditLog.installView.steps.deploymentCompoents.skipAppInstall") }}
              </button>
            </template>
          </div>
        </div>
      </template>
    </Wizard>
  </div>
</template>
<style scoped>
.flex {
  display: flex;
}
.justify-center {
  justify-content: center;
}

.gap-20 {
  gap: 20px;
}
:deep(.controls-row) {
  position: relative;
}
</style>
