---
kind: pipeline
name: test

trigger:
  event:
  # - push
  - pull_request
  - tag

platform:
  os: linux
  arch: amd64

steps:
- name: test
  pull: default
  image: node:12
  commands:
  - scripts/ci

node:
  instance: agent-amd64

---
kind: pipeline
name: docker-tag

depends_on:
- test

trigger:
  event:
  - tag

platform:
  os: linux
  arch: amd64

steps:
- name: docker-image
  image: plugins/docker
  settings:
    build_args:
    - BRANCH=${DRONE_BRANCH}
    - TAG=${DRONE_TAG}
    dockerfile: image-scripts/Dockerfile
    tag: ${DRONE_TAG}
    repo: cnrancher/dashboard
    username:
      from_secret: docker_username
    password:
      from_secret: docker_password
node:
  instance: agent-amd64

---
kind: pipeline
name: embedded-tag

depends_on:
- test

trigger:
  event:
  - tag

platform:
  os: linux
  arch: amd64

steps:
- name: build
  pull: default
  image: node:12
  commands:
  - ./scripts/build-embedded

- name: upload
  pull: default
  image: plugins/s3
  settings:
    bucket: pandaria-dashboard-ui
    region: ap-southeast-2
    acl: public-read
    access_key:
      from_secret: aws_access_id
    secret_key:
      from_secret: aws_access_secret
    source: dist/${DRONE_TAG}.tar.gz
    strip_prefix: dist/
    target: ${DRONE_BRANCH}/

node:
  instance: agent-amd64

---
kind: pipeline
name: hosted-branch

# depends_on:
# - test

trigger:
  ref:
  - "refs/heads/*-dev"
  - "refs/heads/release-*"
  event:
  - push

platform:
  os: linux
  arch: amd64

steps:
- name: build
  pull: default
  image: node:12
  commands:
  - ./scripts/build-hosted
- name: upload
  pull: default
  image: plugins/s3
  settings:
    bucket: pandaria-dashboard-ui
    region: ap-southeast-2
    acl: public-read
    access_key:
      from_secret: aws_access_id
    secret_key:
      from_secret: aws_access_secret
    source: dist/${DRONE_BRANCH}/**/*
    strip_prefix: dist/${DRONE_BRANCH}
    target: /dashboard/${DRONE_BRANCH}

node:
  instance: agent-amd64
